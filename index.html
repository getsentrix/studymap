<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=1200, initial-scale=1.0">
  <title>Map Quiz Studio</title>
  <style>
    :root {
      --bg: #0b1020;
      --panel: rgba(24,26,35,0.93);
      --blur: blur(14px);
      --muted: #232943;
      --text: #f6f7fa;
      --text-dim: #a5adc9;
      --accent: #5a92ff;
      --good: #34d399;
      --bad: #f15f5c;
      --shadow: 0 10px 30px rgba(0,0,0,.18);
      --radius: 27px;
    }
    html,body { height:100%; width:100%; margin:0; padding:0; }
    body {
      background: linear-gradient(125deg, #29325a 0%, #152040 100%);
      color: var(--text);
      font: 500 16px/1.65 'Segoe UI', 'system-ui', Roboto, Helvetica, Arial, sans-serif;
      overflow: hidden;
      min-width:1120px;
    }
    .app {
      display: grid;
      grid-template-columns: 372px 1fr;
      height: 100vh;
      width: 100vw;
      max-width:100vw;
    }
    .panel {
      background: var(--panel);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 2.2rem 2rem 1.5rem 2rem;
      margin: 0 0 0 .7rem;
      min-width: 307px;
      max-width:380px;
      backdrop-filter: var(--blur);
      border: 1.5px solid #2454a511;
      display: flex;
      flex-direction: column;
      gap: 27px;
      overflow-y: auto;
      min-height: 0;
      max-height: 97vh;
    }
    .canvas-panel {
      background: linear-gradient(85deg,#243258,#172847 88%);
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      padding: 0 1vw 0 0;
    }
    .btn, button, input[type="file"] {
      background: var(--muted);
      color: var(--text);
      border: none;
      border-radius: 11px;
      font: inherit;
      padding: 9px 20px;
      font-size: 15px;
      margin: 2px 0;
      cursor: pointer;
      transition: background .16s, box-shadow .13s;
      box-shadow: 0 1px 5px #13193322;
      letter-spacing:.02em;
    }
    .btn:focus-visible, button:focus-visible { outline: 2px solid var(--accent); }
    .btn[disabled], button[disabled] { opacity: 0.5; cursor: not-allowed; }
    button:not([disabled]):hover, .btn:not([disabled]):hover { background: #363e65; color: #ffd874;}
    hr { opacity:.23; border:none; border-bottom:1.6px solid #366; margin:14px -8px 10px -8px;}
    .heading {margin-top:.5rem;margin-bottom:.13rem;font-weight:700;font-size:18.9px;letter-spacing:.03em;}
    .group {margin-bottom:21px;}
    label { margin-right: 8px; color: var(--text-dim);}
    .row { display: flex; align-items: center; gap: 9px; margin-bottom: 5px;}
    h1 { font-size: 2.1rem; font-weight: 800; letter-spacing:.03em; margin-top:.4em;margin-bottom:.4em;}
    input[type="range"] { vertical-align: middle; accent-color: var(--accent);}
    #termsList { max-height: 155px; overflow-y: auto; margin:.2em 0;}
    #termsList .row {
      padding: 2px 0 2px 3px;
      margin-bottom: 0;
      border-radius: 6px;
      transition: background .13s;
    }
    #termsList .row:hover { background: #2c3759;}
    #addTerm {width:70%; margin-right:.65em;padding:7px 10px;border-radius:8px;background:#181d2a;color:var(--text);}
    #addTerm:focus {outline:1.5px solid var(--accent);}
    #mapCanvas {
      max-width: 95vw;
      max-height: 91vh;
      width: 99.5%;
      height: 93vh;
      border-radius:25px;
      outline:2.5px solid #132539;
      background:#101428;
      box-shadow:0 7px 55px #040d2f66;
      display: block;
      margin:auto;
      transition: outline .16s;
    }
    .quiz-num-main {color:var(--accent);font-weight:600;}
    .shortcut {
      font-size: 13px;
      color: var(--accent);
      font-weight:600;
      margin-left: 9px;
      opacity:.83;
      letter-spacing:.03em;
    }
    .section-label { font-size:1.1em; color: #dacbff; letter-spacing:.1em; opacity:.81;}
    .action-main {
      background: linear-gradient(90deg,#3a55e8 0%,#6ad1e3 100%);
      color: #fff;
      font-weight: 790;
      border-radius:14px;
      padding: 14px 0 13px 0;
      font-size:21px;
      box-shadow:0 3px 32px #4950a966;
      border:0;
      margin-bottom:10px;
      transition:transform .12s;
    }
    .action-main:active { transform: scale(.97);}
    ::selection{background: #ffeb88;color:#253;}
    .tip { font-size:13px;color:var(--accent);margin-bottom:8px;}
    .panel::-webkit-scrollbar{width:7px;background:rgba(56,70,120,0.12);}
    .panel::-webkit-scrollbar-thumb{background:#3d4266;border-radius:5px;}
  </style>
</head>
<body>
  <div class="app">
    <div class="panel">
      <h1>Map Quiz Studio</h1>
      <div class="group">
        <button id="export">Export</button>
        <button id="import">Import</button>
        <button id="reset">Reset</button>
      </div>
      <hr />
      <div class="heading">MAP IMAGE</div>
      <div class="row group">
        <input type="file" id="imgInput" accept="image/*">
        <button id="fit">Fit to screen</button>
        <button id="removeImg">Remove image</button>
      </div>
      <div class="tip group">
        Tip: upload your study map (PNG/JPG). In Author mode, click the map to place a pin for a selected term.
      </div>
      <hr/>
      <div class="heading">MODES</div>
      <div class="row group">
        <button id="modeAuthor">Author <span class="shortcut">A</span></button>
        <button id="modeQuiz">Quiz <span class="shortcut">Q</span></button>
        <button id="modeFlash">Flashcards <span class="shortcut">F</span></button>
      </div>
      <div class="row group">
        <label for="tolerance">Tolerance:</label>
        <input type="range" id="tolerance" min="10" max="60" value="24" style="width:80px;">
        <span id="tolVal">24</span> px
      </div>
      <hr/>
      <div class="heading">TERMS</div>
      <div class="row group">
        <input aria-label="Add a term (e.g., Red Sea)" id="addTerm" placeholder="Add a term...">
        <button id="addTermBtn">Add</button>
      </div>
      <div class="row" style="margin-bottom:6px;">
        <button id="loadCountries">Load Middle East – Countries</button>
        <button id="loadFeatures">Load Middle East – Features</button>
        <button id="clearTerms">Clear terms</button>
      </div>
      <div id="termsList" class="group"></div>
      <hr/>
      <div class="heading">QUIZ CONTROLS</div>
      <button id="start" class="action-main">Start / Shuffle <span class="shortcut">S</span></button>
      <div class="row">
        <button id="reveal">Reveal <span class="shortcut">R</span></button>
        <button id="undo">Undo <span class="shortcut">U</span></button>
        <button id="togglePins">Toggle pins</button>
      </div>
      <div class="row"><span>Mode: <b id="modeStatus"></b></span></div>
      <div class="row">
        <span>Score: <b id="score" class="quiz-num-main">0</b> / <span id="total" class="quiz-num-main">0</span></span>
        <span>Streak: <b id="streak">0</b></span>
      </div>
      <div class="row"><span>Target: <b id="targetTerm"></b></span></div>
      <div class="row"><button id="next" style="flex:1;">Next <span class="shortcut">N, Space</span></button></div>
    </div>
    <div class="canvas-panel">
      <canvas id="mapCanvas" tabindex="0"></canvas>
    </div>
  </div>
  <script>
    // === STATE/LOGIC
    let state = { img: null, pins: [], terms: [], mode: 'Author', tolerance: 24, quizOrder: [], quizIdx: 0, score: 0, streak: 0, pinsEnabled: true };
    const saveState = () => localStorage.setItem('studiemap', JSON.stringify(state));
    const loadState = () => { try { const x = JSON.parse(localStorage.getItem('studiemap')); if (x) Object.assign(state, x); } catch {}};
    const clearState = () => { localStorage.removeItem('studiemap'); location.reload(); };
    const el = id => document.getElementById(id);

    // CANVAS, STYLING + IMAGE
    let canvas = el('mapCanvas'), ctx = canvas.getContext('2d'), img = new window.Image();

    function fitCanvas() {
      let calcW = window.innerWidth - 420, calcH = window.innerHeight - 60;
      canvas.width = Math.max(750, Math.min(calcW, 1320));
      canvas.height = Math.max(490, Math.min(calcH, 910));
      drawCanvas();
    }
    window.onresize = fitCanvas;

    function drawCanvas() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      if (state.img) {
        if (!img.src || img.src !== state.img) {
          img.onload = drawCanvas;
          img.src = state.img;
          return;
        }
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      } else {
        ctx.fillStyle = '#232a4a';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#7fa7fa77';
        ctx.font = '28px sans-serif';
        ctx.fillText('No image', canvas.width/2-66, canvas.height/2);
      }
      if (state.pinsEnabled && state.pins.length)
        state.pins.forEach(p=>drawPin(p.x,p.y,p.termIdx,false));
    }
    function drawPin(x, y, idx, ghost) {
      ctx.save();
      ctx.globalAlpha = ghost ? 0.73 : 1;
      ctx.beginPath();
      ctx.arc(x, y, 13, 0, 2*Math.PI); ctx.fillStyle = ghost ? '#e7ecff77' : '#5a92ff'; ctx.fill();
      ctx.lineWidth = 3.2; ctx.strokeStyle = '#101428'; ctx.stroke();
      ctx.font = '15px bold Segoe UI,sans-serif'; ctx.fillStyle = '#18182b'; ctx.textAlign = 'center';
      ctx.fillText(state.terms[idx]?.substr(0,2).toUpperCase()||'', x, y + 6);
      ctx.restore();
    }
    function setMode(m) { state.mode = m; el('modeStatus').textContent = m; saveState(); drawCanvas(); updateUI(); }
    ['modeAuthor','modeQuiz','modeFlash'].forEach((id,i) => el(id).onclick = () => setMode(['Author','Quiz','Flashcards'][i]));
    el('tolerance').oninput = e => state.tolerance = parseInt(el('tolVal').textContent = e.target.value,10), saveState();
    el('removeImg').onclick = () => { state.img = null; img.src = ""; saveState(); drawCanvas(); };
    el('imgInput').onchange = e => {
      let f = e.target.files[0]; if (!f) return;
      let reader = new FileReader();
      reader.onload = r => { state.img = r.target.result; img.onload = drawCanvas; img.src = state.img; saveState(); };
      reader.readAsDataURL(f);
    };
    el('fit').onclick = fitCanvas;
    el('addTermBtn').onclick = addTermEvent;
    el('addTerm').onkeypress = e=>{ if(e.key==='Enter') addTermEvent(); };
    function addTermEvent() {
      let v=el('addTerm').value.trim();
      if(!v||state.terms.includes(v))return;
      state.terms.push(v);
      saveState();
      el('addTerm').value='';
      updateTerms();
    }
    el('clearTerms').onclick = ()=>{ state.terms = []; state.pins = []; saveState(); updateTerms(); drawCanvas(); };
    function updateTerms() {
      let out = '';
      state.terms.forEach((t,i)=> {
        out += `<div class="row"><span>${t}</span><button onclick="window.delTerm(${i})">🗑️</button></div>`;
      });
      el('termsList').innerHTML = out;
      el('total').textContent = state.terms.length;
      saveState();
    }
    window.delTerm = idx => { 
      state.terms.splice(idx,1); 
      state.pins = state.pins.filter(p=>p.termIdx!=idx); 
      saveState(); 
      updateTerms(); 
      drawCanvas(); 
    };
    function updateUI() {
      el('score').textContent = state.score;
      el('streak').textContent = state.streak;
      el('targetTerm').textContent = state.quizOrder?.length ? state.terms[state.quizOrder[state.quizIdx]] : '—';
      el('modeStatus').textContent = state.mode;
      el('next').disabled = (state.mode=='Author');
      saveState();
    }
    el('start').onclick = () => {
      if (!state.terms.length) return alert('Add terms first!');
      state.quizOrder = Array.from({length:state.terms.length},(_,i)=>i).sort(()=>Math.random()-.5);
      state.quizIdx=0; state.score=0; state.streak=0; setMode('Quiz');
      updateUI();
    };
    el('next').onclick = () => { nextQuizStep(); };
    function nextQuizStep() {
      state.quizIdx = ((state.quizIdx+1)%state.quizOrder.length)||0;
      updateUI();
    }
    el('reveal').onclick = () => {
      if (state.mode == 'Quiz') {
        alert('Location: '+state.terms[state.quizOrder[state.quizIdx]]);
      }
    };
    el('undo').onclick = () => { if(state.pins.length) state.pins.pop(); drawCanvas(); saveState(); };
    el('togglePins').onclick = () => { state.pinsEnabled = !state.pinsEnabled; drawCanvas(); saveState(); };
    canvas.onclick = e => {
      if (!state.img || state.mode=='Flashcards') return;
      let rect = canvas.getBoundingClientRect();
      let x = (e.clientX-rect.left), y = (e.clientY-rect.top);
      if (state.mode == 'Author') {
        if(state.terms.length){
          let tidx=state.terms.length-1;
          state.pins.push({termIdx:tidx,x,y});
          saveState(); drawCanvas();
        }
      } else if (state.mode == 'Quiz' && state.quizOrder.length) {
        let tidx = state.quizOrder[state.quizIdx], found=false;
        for (const p of state.pins) {
          if (p.termIdx==tidx && Math.hypot(p.x-x,p.y-y)<(state.tolerance||24)) found=true;
        }
        if (found) { state.score+=1; state.streak+=1; flash(canvas,'#34d399'); } else { state.streak=0; flash(canvas,'#ef4444'); }
        nextQuizStep(); updateUI();
      }
    };
    function flash(node,color){
      node.style.boxShadow = `0 0 0 14px ${color}80`;
      setTimeout(()=>node.style.boxShadow='',350);
    }
    document.addEventListener('keydown',e=>{
      if(document.activeElement.tagName=='INPUT')return;
      switch(e.key.toLowerCase()){
        case 'a': setMode('Author'); break;
        case 'q': setMode('Quiz'); break;
        case 'f': setMode('Flashcards'); break;
        case 's': el('start').onclick(); break;
        case 'n': el('next').onclick(); break;
        case 'r': el('reveal').onclick(); break;
        case 'u': el('undo').onclick(); break;
        case ' ': el('next').onclick(); break;
      }
    });
    el('export').onclick = () => {
      navigator.clipboard.writeText(JSON.stringify(state));
      alert('State copied! Paste it to restore on any device.');
    };
    el('import').onclick = () => {
      let d = prompt('Paste state here:'), s;
      try { s=JSON.parse(d); } catch { return alert('Invalid.'); }
      if(s && s.terms && s.img){ Object.assign(state,s); saveState(); location.reload(); }
    };
    el('reset').onclick = ()=>{ if(confirm('Reset everything?')) clearState(); };
    el('loadCountries').onclick = ()=>{
      state.terms = ["India","Iran","Iraq","Sri Lanka","Pakistan","Afghanistan","Yemen","Bhutan","Russia","Bangladesh","China","Japan","Korea","Mongolia","Myanmar","Vietnam","Laos","Indonesia","Thailand"];
      updateTerms(); saveState(); };
    el('loadFeatures').onclick = ()=>{
      state.terms = ["Arabian Sea","Bay of Bengal","Indus River","Indian Ocean","Ganges River","Pacific Ocean","Yellow Sea","Huang River","Yangtze River","East Sea","South Sea","Persian Gulf","Himalayas","Gobi Desert","Hindu Kush","Tibet"];
      updateTerms(); saveState();
    };
    loadState();
    fitCanvas();
    updateTerms();
    updateUI();
    if(state.img){ img.onload = drawCanvas; img.src = state.img; }
    canvas.ondragover = e => { e.preventDefault(); canvas.style.outlineColor = "#7aa2ff"; };
    canvas.ondragleave = e => { canvas.style.outlineColor = "#182639"; };
    canvas.ondrop = e => {
      e.preventDefault(); var dt = e.dataTransfer;
      if(dt.files && dt.files.length){
        let fr=new FileReader();
        fr.onload= r => { state.img = r.target.result; img.onload = drawCanvas; img.src = state.img; saveState(); };
        fr.readAsDataURL(dt.files[0]);
      }
      canvas.style.outlineColor = "#182639";
    }
  </script>
</body>
</html>
